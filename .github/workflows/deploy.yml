name: Deploy iGEM Media Gallery to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      artifact_id: ${{ steps.upload_artifact.outputs.artifact_id }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python (no pip cache)
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: ''

      - name: Run rename script (optional)
        run: |
          if [ -f rename.py ]; then
            echo "Found rename.py — running non-interactively."
            printf "2\ny\n" | python rename.py || echo "⚠ rename.py 运行失败，继续"
          elif [ -f rename_media.py ]; then
            echo "Found rename_media.py — running non-interactively."
            printf "2\ny\n" | python rename_media.py || echo "⚠ rename_media.py 运行失败，继续"
          else
            echo "No rename script found, skipping rename step"

      - name: Debug current directory
        run: |
          echo "当前工作目录: $(pwd)"
          echo "目录内容:"
          ls -la

      - name: Build website (with fallback)
        run: |
          if [ -f build_site.py ]; then
            echo "Found build_site.py — running..."
            python build_site.py || echo "⚠ build_site.py 执行失败，使用 fallback gallery.html"
          else
            echo "未找到 build_site.py，创建基础 gallery.html..."
            cat > gallery.html << 'GALLERY_EOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYPHU-CHINA iGEM Media Gallery</title>
    <style>
        body { font-family: Arial,sans-serif; margin:0; padding:20px; background:#f5f7fa; }
        h1 { text-align:center; color:#2c3e50; }
        .gallery { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:20px; margin-top:30px; }
        .media-item { border:1px solid #e1e8ed; border-radius:8px; padding:15px; text-align:center; background:#f8f9fa; }
    </style>
</head>
<body>
    <h1>SYPHU-CHINA iGEM Media Gallery</h1>
    <p>ART 和 HP 目录暂无媒体文件</p>
</body>
</html>
GALLERY_EOF

      - name: Create index.html redirect
        run: |
          cat > index.html << 'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="0; url=gallery.html">
    <title>SYPHU-CHINA iGEM Media Gallery</title>
</head>
<body>
    <p>正在跳转到 <a href="gallery.html">gallery.html</a>...</p>
</body>
</html>
EOF

      - name: Prepare site folder
        run: |
          rm -rf site
          mkdir -p site
          cp -f gallery.html index.html site/
          [ -d ART ] && cp -r ART site/
          [ -d HP ] && cp -r HP site/
          echo "site/ 内容:"
          ls -la site/

      - name: Upload static site as Pages artifact
        id: upload_artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
